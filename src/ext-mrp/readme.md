# Алгоритм планирования ресурсов - MRP

Для работы алгоритма необходимо внесение следующих основных данных:

* **ресурсы**: материалы и сырье, которые используются в производстве продуктов
* **продукты**: перечень продукции, производство которой планируется
* **стадии**: схема производства продукции
* **реестр остатков ресурсов**: сколько ресурсов было на начало периода и сколько ресурсов находится в процессе 
доставки и прибудет несколько позднее начальной даты планирования
* **реестр остатков продукции**: сколько готовой продукции было на складе на начало периода, и какие партии 
продукции находятся в производстве на начало периода

Входящие данные алгоритма:
* количество продукции, которое нужно для сбыта на указанные даты - план продаж.

Результат работы алгоритма:
* план закупок сырья и материалов - календарный и стоимостной

## Планы

План состоит из головного документа и элементов. 

План может быть основан на другом плане - тогда вся цепочка связанных планов обрабатывается совместно. Функция 
необходима для введения сценариев. 

## Ресурсы
 
Ресурсы - это материалы и сырье. Описание ресурса включает в себя:

* id: идентификатор ресурса
* caption: название ресурса
* unit: название единицы измерения ресурса
* minStock: минимальный остаток ресурсов, при котором заказывается следующая партия

Методы:
* обработать ресурсы в транзите - сформировать регистр остаток ресурсов с учетом поступления 
ресурсов из транзита. Посмотреть остатки можно через ресурс "resource-stock"
* получить остатки ресурсов на определенную дату.
* сделать заказ сырья к определенной дате: получить срок размещения заказа


## А2. Алгоритм

А2.1. Запускаем обработку при создании задачи планирования: в ней указаны планы, которые необходимо учитывать. 
Для выбранного плана получаем всю цепочку указанных планов и запоминаем ее для расчётов. Сохраняем событие о 
расчёте цепочки планов. 

А2.2. Обрабатываем ресурсы в транзите. 
Формируем регистр остатков ресурсов на определенные даты с учётом транзита. 
Для каждой операции указывается - какой план был основанием для операции. 
(2020): ресурсы в транзите записываются как записи в регистр остатков ресурсов с признаком: 
в транзите. Обрабатываем так: так как запись ресурса в транзите указана по дате отправки - нам необходимо 
рассчитать дату поступления партии ресурсов на склад. Для этого мы берем каждую партию ресурсов 
в транзите, берем поставщика, у которого мы ее купили и получаем сведения о длительности транзита,
а приходную операцию на склад записываем расчетной датой поступления, ссылаясь на нужную калькуляцию. 

А2.3. Обрабатываем продукцию в производстве. Для каждой партии в производстве: известна дата начала производства партии 
продукции. Требуется провести списание ресурсов и оприходование готовой продукции (количество готовой продукции должно 
быть указано в регистре продукции в производстве) по уже запущенным в производство 
партиям продукции - эти партии не планируются, но они будут фактически изготовлены и изменят остатки как ресурсов, 
так и продукции. Следовательно, это необходимо учесть. 

Берем текущую партию продукции в производстве. Берем этапы производства от самого первого до последнего. 
Для каждого этапа списываем ресурсы на производство продукции и по итогам фиксируем остатки продукции в результате 
производства. Если ресурсов не хватает на этап - фиксируем ошибку: невозможно было запустить производство в отсутствие 
необходимых ресурсов. Фиксируем - какой план был основанием для внесения данных. 

Начинаем обрабатывать план производства. Сортируем план в хронологическом порядке и по видам продукции. Обрабатываем 
каждую позицию плана от самой ранней к самой поздней. 

А2.4. Берем текущую запись в плане. Вычисляем остаток продукции на эту дату. 
Сравниваем с потребностью в передаче продукции в продажи из текущей записи плана. Фиксируем ситуацию событием. 
Если продукции не хватает, необходимо будет запланировать производство партии 
продукции к дате в текущей записи плана. Фиксируем ситуацию событием.
Если продукции хватает, необходимо зафиксировать передачу партии продукции для реализации. 

А2.5. Планируем производство партии продукции.   
Фиксируем планирование событием. 
2.5.0: делаем расчет партии производства для выполнения плана.
2.5.1. Берем все этапы производства этой продукции. Сортируем в порядке следования прозводственных этапов, от 
самых первых этапов к последующим. 
2.5.2 Берем текущий этап. Запоминаем текущую дату. 
Производим вычисление даты начала этого этапа. Если дата меньше начальной даты в системе - 
пишем ошибку и прекращаем расчеты: система не может получить нужную продукцию к запланированной дате. 

2.5.3. Получаем список ресурсов, требуемых для данного этапа. 
Для каждого ресурса получаем остаток на дату начала этапа. Производим расчет требуемого объема ресурсов 
для данного производственного этапа. 

2.5.3.1. Если остатки ресурсов не позволяют начать этап, производим планирование 
поставки партии ресурсов. Если планирование поставки партии ресурсов по дате заказа меньше начальной даты в системе -
пишем ошибку и прекращаем процесс расчёта: система не может запланировать поставку ресурса к плановой дате.

Берём новые остатки ресурсов с учётом запланированной поставки. Если остатки ресурсов позволяют произвести продукцию, 
сохраняем данные о себестоимости производства и фиксируем расход ресурсов на производство. 

Вычислить дату начала этапа: дата конечная, продукция, этап. Сортируем этапы хронологически. От самого 
последнего этапа начинаем. Отнимаем от даты конечной длительность текущего этапа. Если это требуемый этап -
возвращаем дату начала. Если этапы кончились - ошибка. Иначе - берем предшествующий этап.

А2.6. Планирование поставки партии ресурсов: 
на входе - дата поступления ресурсов и требуемое количество (имеющиеся и необходимое), калькуляция
Справочно указываем основание заказа (позиция в плане производства и этап).

А2.6.1. Сначала необходимо найти поставщика, который на дату заказа будет поставлять продукцию.
Получаем длительность перевозки и изготовления требуемого ресурса для расчёта даты заказа. 
На эту дату получаем - какой поставщик и условия поставки будут действовать. 

Проверяем уже открытые заказы этому поставщику: если в период от даты начала заказа до даты завершения заказа
на склад поступает партия ресурсов от этого поставщика, то требуется её увеличить на требуемое количество.

если партия от этого поставщика поступает в 
период, когда мы должны заказать эту партию ресурсов - то вместо заказа новой партии необходимо скорректировать ту 
поставку. Для этого каждая поставка должна содержать основания заказа и параметры (сколько заказано для выполнения 
производственного плана, а сколько заказано для получения минимальной партии поставки). Если нужно - планируем новую 
поставку и в соответствии с этими условиями записываем 
финансовые планы и требуемое количество ресурса для заказа. Записываем в список партий ресурсов эту партию
как заказанную (planned order). Основание заказа - план, продукция, этап. 

Получить остаток ресурсов на дату: берем перечень всех партий ресурсов в хронологическом 
порядке - от начальных остатков, остатков в транзите, и спланированных поставок. Далее получаем 
список всех расходных операций на дату. Соотносим приходные операции и расходные операции. Оставляем 
список всех партий, у которых остаток получился положительный - его и возвращаем.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           

Списать ресурсы на производство: продукция, этап, дата начала этапа. Берем список ресурсов, требуемый
для данного этапа. Для каждого ресурса берем текущий ресурс. Получаем остатки этого ресурса на дату. 
Делаем расчет требуемого количества ресурса на производство. Если ресурса не хватает - пишем об ошибке.
Если ресурса хватает, то для каждой партии ресурса на складе списываем имеющееся количество ресурсов 
из этой партии до тех пор, пока не наберем требуемое количество ресурсов.
   
## Важные замечания

Алгоритм не учитывает планирование продаж - план представляет собой сразу план производственных партий. 
Для учета плана продаж необходима агрегация планов продаж из различных источников, планирование остатка 
продукции, соотнесение их с планом продаж и планирование производственных партий.
   
## База данных

### Plan: план продаж

* **id**: идентификатор
* **caption**: название плана

### PlanItem: элемент плана

* **id**: идентификатор
* **planId**: к какому плану относится данный элемент
* **date**: дата завершения производства
* **caption**: описание элемента в свободной форме
* **productId**: продукт
* **qnt**: количество продукта из производства 

### PlanCalc: MRP-калькуляция

* **id**: идентификатор
* **planId**: (-> `Plan.id`)к какому плану относится калькуляция
* **createdAt**: время начала создания калькуляции
* **finishedAt**: время завершения создания калькуляции
* **status**: статус данной калькуляции (в процессе, завершено ок, ошибка)

### Product: продукция

* **id**: идентификатор продукции
* **caption**: название продукции
* **unit**: единица измерения,
* **qntMin**: минимальная партия для производства
* **qntStep**: шаг изменения партии производства
* **comments**: примечания

### ProductStock: регистр учета остатков продукции

Справочник содержит сведения о движении продукции на складе готовой продукции

* **id**: идентификатор
* **date**: дата, на которую зафиксирован остаток продукции
* **type**: тип остатка продукции:
  * 0 - `unknown`: неизвестный тип,
  * 1 - `initial`: начальный остаток
  * 2 - `inProd`: заказанная в производство продукция, но не переданная на склад на определенную дату,
  * 3 - `prod`: поступление продукции из производства на склад,
  * 4 - `sales`: передача продукции в реализацию
* **productId**: (-> Product.id) продукция
* **caption**: примечания об этой записи об остатках
* **qnt**: количество продукции на остатке
* **price**: стоимость единицы остатка продукции

### Resource: сырье и материалы

* `id`: идентификатор 
* `caption`: название
* `unit`: единица измерения
* `minStock`: минимальный остаток, при достижении которого необходимо сделать заказ

### ResourceStock: регистр учёта сырья и материалов

Справочник содержит сведения о движении сырья и материалов

* `id`: идентификатор
* `type`: тип операции:
   * 0 - `unknown`: неизвестный тип
   * 1 - `initial`: начальный остаток
   * 2 - `inTransfer`: заказанные сырье и материалы, но еще не поступившие на склад
   * 3 - `ordered`: поступление сырья от поставщика
   * 4 - `used`: выбытие сырья в производство
* `resourceId`: (-> Resource.id) сырье и материалы
* `date`: дата операции
* `qnt`: количество
* `price`: цена единицы
* `vendorId`: поставщик
* `caption`: примечания

### Stage: этапы производства

* `id`: идентификатор
* `order`: порядковый номер для сортировки
* `productId`: (-> `Product.id`) производимый продукт
* `caption`: название этапа
* `duration`: длительность этапа
* `inWorkingDays`: признак, указана ли длительность в рабочих днях (если нет, то - в календарных)
* `baseQnt`: базовое количество, относительно которого указана норма расхода
* `comments`: примечания

### StageResource: сырье и материалы этапа производства

Сведения о сырье и материалах, потребляемых на этапе производства - нормы расхода

* `id`: идентификатор
* `stageId`: (-> `Stage.id`) этап, к которому относится сведения
* `resourceId`: (-> `Resource.id`) ресурс, норма расхода которого
* `qnt`: норма расхода - относительно `Stage.baseQnt`

